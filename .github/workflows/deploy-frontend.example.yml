# âš ï¸ Ce fichier est un exemple - Ã€ renommer en deploy-frontend.yml et configurer les secrets
# Configuration requise dans GitHub Settings â†’ Secrets :
# - VPS_HOST : Adresse IP de votre VPS OVH
# - VPS_USER : Nom d'utilisateur SSH (ubuntu)
# - VPS_SSH_KEY : Votre clÃ© SSH privÃ©e complÃ¨te
# - VPS_FRONTEND_PATH : /var/www/fleet-frontend

name: Deploy Frontend to OVH

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch: # Permet le dÃ©clenchement manuel depuis GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Installer Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. Installer les dÃ©pendances
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 4. Linter (optionnel)
      - name: ğŸ” Run linter
        run: npm run lint || true

      # 5. Tests (optionnel - dÃ©commenter si vous avez des tests)
      # - name: ğŸ§ª Run tests
      #   run: npm test

      # 6. Build de production
      - name: ğŸ”¨ Build for production
        env:
          VITE_API_URL: https://api.votredomaine.tn/api/v1
        run: npm run build

      # 7. Afficher la taille du build
      - name: ğŸ“Š Check build size
        run: du -sh dist/

      # 8. Backup et nettoyage sur le serveur
      - name: ğŸ’¾ Backup old version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸš€ DÃ©ploiement du frontend..."

            # CrÃ©er un backup de l'ancien build
            sudo cp -r ${{ secrets.VPS_FRONTEND_PATH }} ${{ secrets.VPS_FRONTEND_PATH }}-backup-$(date +%Y%m%d-%H%M%S) || true

            # Nettoyer le dossier de destination
            sudo rm -rf ${{ secrets.VPS_FRONTEND_PATH }}/*

            echo "âœ… Ancien build sauvegardÃ© et dossier nettoyÃ©"

      # 9. Copier les fichiers via SCP
      - name: ğŸ“¤ Copy files to VPS
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "dist/*"
          target: "/tmp/fleet-frontend-new"
          strip_components: 1

      # 10. Finaliser le dÃ©ploiement
      - name: âœ… Finalize deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸ“¦ DÃ©placement des fichiers..."
            sudo mv /tmp/fleet-frontend-new/* ${{ secrets.VPS_FRONTEND_PATH }}/

            echo "ğŸ” Configuration des permissions..."
            sudo chown -R www-data:www-data ${{ secrets.VPS_FRONTEND_PATH }}
            sudo chmod -R 755 ${{ secrets.VPS_FRONTEND_PATH }}

            echo "ğŸ§¹ Nettoyage..."
            sudo rm -rf /tmp/fleet-frontend-new

            echo "âœ… DÃ©ploiement du frontend terminÃ© avec succÃ¨s!"

            # Garder seulement les 5 derniers backups
            cd $(dirname ${{ secrets.VPS_FRONTEND_PATH }})
            ls -t fleet-frontend-backup-* 2>/dev/null | tail -n +6 | xargs -r sudo rm -rf

      # 11. Test du dÃ©ploiement
      - name: ğŸ§ª Health check
        run: |
          sleep 5
          curl -f https://votredomaine.tn || exit 1
          echo "âœ… Frontend accessible!"

      # 12. Notification de succÃ¨s
      - name: ğŸ‰ Deployment success
        if: success()
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi!"
          echo "ğŸŒ URL: https://votredomaine.tn"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”¨ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Par: ${{ github.actor }}"

      # 13. Notification d'Ã©chec
      - name: âŒ Deployment failure
        if: failure()
        run: |
          echo "âŒ Le dÃ©ploiement a Ã©chouÃ©!"
          echo "ğŸ” VÃ©rifiez les logs ci-dessus"
